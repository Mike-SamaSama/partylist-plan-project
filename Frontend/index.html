<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Party-List Registration Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .details-content { transition: max-height 0.3s ease-out, opacity 0.3s ease-out; max-height: 0; opacity: 0; overflow: hidden; }
        .details-content.open { max-height: 1500px; opacity: 1; } 
        .completed-phase .phase-title { text-decoration: line-through; color: #4c5563; }
        .completed-phase .phase-banner { background-color: #f5f5f4; border-color: #e7e5e4; }
        .prose h1 { font-size: 1.25em; font-weight: bold; margin-bottom: 0.5em; color: #047857; }
        .prose h2 { font-size: 1.1em; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; color: #065f46; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
    </style>
</head>
<body class="bg-stone-50 text-stone-800 relative">
    
    <header class="sticky top-0 z-40 bg-white/90 backdrop-blur-md shadow-sm">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col sm:flex-row justify-between items-center py-4 border-b border-stone-200">
                <h1 class="text-2xl font-bold text-emerald-700 flex items-center gap-2">
                    Party-List Registration Tracker
                    <span class="bg-emerald-100 text-emerald-800 text-xs font-medium px-2.5 py-0.5 rounded-full border border-emerald-200">AI Enabled ✨</span>
                </h1>
                <nav class="mt-2 sm:mt-0">
                    <ul class="flex flex-wrap justify-center space-x-3 sm:space-x-4">
                        <li><a href="#phase-1" class="text-sm font-medium text-stone-600 hover:text-emerald-600 transition-colors">Phase I</a></li>
                        <li><a href="#phase-2" class="text-sm font-medium text-stone-600 hover:text-emerald-600 transition-colors">Phase II</a></li>
                        <li><a href="#phase-3" class="text-sm font-medium text-stone-600 hover:text-emerald-600 transition-colors">Phase III</a></li>
                        <li><a href="#phase-4" class="text-sm font-medium text-stone-600 hover:text-emerald-600 transition-colors">Phase IV</a></li>
                        <li><a href="#phase-5" class="text-sm font-medium text-stone-600 hover:text-emerald-600 transition-colors">Phase V</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="max-w-3xl mx-auto">
            <h2 class="text-3xl font-extrabold text-stone-900 text-center">A Step-by-Step Implementation Guide</h2>
            <p class="mt-4 text-lg text-stone-600 text-center">
                Track your progress, upload documents to the cloud, and generate legal forms.
            </p>
            <p class="mt-2 text-sm text-center text-emerald-700 font-semibold">
                Your User ID: <span id="user-id-display">[Generating...]</span>
            </p>
            <div id="timeline-container" class="mt-16 space-y-12"></div>
        </div>
    </main>

    <button id="ai-fab" class="fixed bottom-6 right-6 z-50 bg-gradient-to-r from-emerald-600 to-teal-600 text-white rounded-full p-4 shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-300 flex items-center gap-2 group">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
        <span class="font-bold pr-1">AI Assistant</span>
    </button>

    <div id="ai-modal" class="fixed inset-y-0 right-0 w-full sm:w-96 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-50 border-l border-stone-200 flex flex-col">
        <div class="bg-emerald-700 text-white p-4 flex justify-between items-center">
            <h3 class="font-bold text-lg flex items-center gap-2">Party-List Architect ✨</h3>
            <button id="close-ai-modal" class="text-emerald-100 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
        </div>
        <div class="flex border-b border-stone-200">
            <button class="flex-1 py-3 text-sm font-medium text-emerald-700 border-b-2 border-emerald-700 bg-emerald-50" id="tab-drafter">✨ Smart Drafter</button>
            <button class="flex-1 py-3 text-sm font-medium text-stone-500 hover:text-emerald-600" id="tab-consultant">⚖️ Legal Q&A</button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 bg-stone-50" id="ai-content-area">
            <div id="view-drafter" class="space-y-4">
                <div class="bg-white p-4 rounded-lg shadow-sm border border-stone-200">
                    <p class="text-xs text-stone-500 mb-3">Generate custom drafts for your core legal documents.</p>
                    <label class="block text-xs font-bold text-stone-700 mb-1">Party-List Name</label>
                    <input type="text" id="ai-party-name" class="w-full text-sm p-2 border border-stone-300 rounded mb-3" placeholder="e.g., Angat Kabuhayan">
                    <label class="block text-xs font-bold text-stone-700 mb-1">Sector</label>
                    <input type="text" id="ai-sector" class="w-full text-sm p-2 border border-stone-300 rounded mb-3" placeholder="e.g., Fisherfolk">
                    <label class="block text-xs font-bold text-stone-700 mb-1">Advocacy</label>
                    <textarea id="ai-advocacy" class="w-full text-sm p-2 border border-stone-300 rounded mb-3" rows="2" placeholder="e.g., Subsidized boats."></textarea>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="btn-draft-platform" class="bg-emerald-600 text-white text-xs font-bold py-2 px-3 rounded hover:bg-emerald-700 flex items-center justify-center gap-1"><span>Draft Platform</span> ✨</button>
                        <button id="btn-draft-preamble" class="bg-teal-600 text-white text-xs font-bold py-2 px-3 rounded hover:bg-teal-700 flex items-center justify-center gap-1"><span>Draft Preamble</span> ✨</button>
                    </div>
                </div>
                <div id="ai-output-container" class="hidden">
                    <div id="ai-output" class="bg-white p-4 rounded-lg shadow-inner border border-emerald-100 text-sm prose leading-relaxed h-64 overflow-y-auto"></div>
                    <button id="copy-draft" class="mt-2 w-full bg-white border border-stone-300 text-stone-600 text-xs font-bold py-1 rounded hover:bg-stone-50">Copy to Clipboard</button>
                </div>
            </div>
            <div id="view-consultant" class="hidden space-y-4 h-full flex flex-col">
                <div id="chat-history" class="flex-1 bg-white p-4 rounded-lg shadow-inner border border-stone-200 overflow-y-auto text-sm space-y-3">
                    <div class="bg-emerald-50 p-3 rounded-lg rounded-tl-none border border-emerald-100 text-stone-700">Hello! I am your Party-List Registration Assistant. Ask me about deadlines, requirements, or document formatting.</div>
                </div>
                <div class="flex gap-2 mt-auto">
                    <input type="text" id="chat-input" class="flex-1 text-sm p-2 border border-stone-300 rounded" placeholder="Ask a question...">
                    <button id="btn-send-chat" class="bg-emerald-600 text-white p-2 rounded hover:bg-emerald-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg></button>
                </div>
            </div>
        </div>
        <div id="ai-loading" class="absolute inset-0 bg-white/80 flex flex-col items-center justify-center z-10 hidden rounded-lg">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-700"></div>
            <p class="text-xs text-emerald-700 mt-2 font-semibold">Generating...</p>
        </div>
    </div>

    <script type="module">
        // --- GLOBAL CONFIGURATION ---
        window.userId = null;
        const apiKey = ""; // Insert Gemini API Key here if needed for frontend testing
        
        // IMPORTANT: REPLACE THIS WITH YOUR GOOGLE CLOUD FUNCTION URL AFTER DEPLOYMENT
        const API_URL = "https://YOUR-REGION-YOUR-PROJECT-ID.cloudfunctions.net/log_submission"; 

        // --- TEMPLATE CONSTANTS (Placeholder for brevity, assume full templates from previous steps exist) ---
        const TEMPLATE_CONSTITUTION = `# CONSTITUTION AND BY-LAWS... (Full Text)`;
        const TEMPLATE_PLATFORM = `# PLATFORM... (Full Text)`;
        // ... (Assume all templates are defined here as per V4)

        const planData = [
            {
                id: "phase-1",
                phase: "Phase I: Conceptualization and Legal Foundation",
                timeline: "Q4 2025 – Q4 2026",
                documents: ["Constitution & By-Laws Draft", "Platform & Program Draft", "Initial Membership Roster", "List of Officers (Draft)"],
                templates: [
                    { name: "Constitution & By-Laws", filename: "PartyList_Constitution_ByLaws.md", content: TEMPLATE_CONSTITUTION },
                    { name: "Platform of Government", filename: "PartyList_Platform_Program.md", content: TEMPLATE_PLATFORM }
                ],
                steps: [
                    { step: "1.0", activity: "Define Identity and Sector", deliverable: "Sectoral Identity Definition", legalBasis: "R.A. 7941 (Secs. 2 & 3)", doc: "Sectoral Identity Resolution" },
                    { step: "1.1", activity: "Formulate Core Documents", deliverable: "Constitution, By-Laws, Platform", legalBasis: "R.A. 7941 (Sec. 5)", doc: "Constitution & By-Laws (Draft)" },
                    { step: "1.2", activity: "Initial Membership Drive", deliverable: "Verifiable Membership Base", legalBasis: "R.A. 7941 (Sec. 5)", doc: "Initial Membership Roster" },
                    { step: "1.3", activity: "Verify Name Availability", deliverable: "COMELEC Name Verification", legalBasis: "COMELEC Rules", doc: "COMELEC Name Verification Request" },
                    { step: "1.4", activity: "Establish Physical Office", deliverable: "Principal Office Address Proof", legalBasis: "COMELEC requirement", doc: "Proof of Principal Address" }
                ]
            },
            {
                id: "phase-2",
                phase: "Phase II: Organizational Documentation",
                timeline: "3 Years to 18 Months before Petition",
                documents: ["1-Year Track Record Report (Annex D)", "Affidavits of Membership (Annex E)", "Financial Statements (Annex G)", "Organizational Profile (Annex I)"],
                templates: [], // Add phase 2 templates here
                steps: [
                    { step: "2.0", activity: "Establish Track Record", deliverable: "Proof of Advocacy", legalBasis: "R.A. 7941 (Sec. 6)", doc: "1-Year Track Record Report (Annex D)" },
                    { step: "2.1", activity: "Document Membership", deliverable: "Affidavits of Membership", legalBasis: "R.A. 7941 (Sec. 5)", doc: "Affidavits of Membership (Annex E)" },
                    { step: "2.2", activity: "Prepare Financial Statements", deliverable: "Proof of Financial Capacity", legalBasis: "COMELEC requirement", doc: "Sworn Financial Status (Annex G)" },
                    { step: "2.4", activity: "Data Privacy Compliance", deliverable: "NPC Registration", legalBasis: "R.A. 10173", doc: "NPC Registration Certificate" }
                ]
            },
            {
                id: "phase-3",
                phase: "Phase III: Government Registration (Legal Status)",
                timeline: "Q1 – Q3 2026",
                documents: ["CDA/DOLE Cert (Annex A)", "BIR TIN (Form 2303)", "Bank Resolution (Annex H Support)"],
                templates: [], // Add phase 3 templates here
                steps: [
                    { step: "3.0", activity: "Register with Agency", deliverable: "CDA/DOLE Certificate", legalBasis: "R.A. 7941", doc: "Certificate of Registration (Annex A)" },
                    { step: "3.1", activity: "Obtain TIN", deliverable: "BIR Registration", legalBasis: "Tax Code", doc: "BIR Certificate of Registration" },
                    { step: "3.2", activity: "Open Bank Account", deliverable: "Bank Account", legalBasis: "Campaign Finance Rules", doc: "Bank Account Resolution" }
                ]
            },
            {
                id: "phase-4",
                phase: "Phase IV: COMELEC Registration (Petition)",
                timeline: "Late 2027 – Early 2028",
                documents: ["Petition for Registration", "Manifestation of Intent", "Proof of Publication", "Coalition Agreement", "Officers' Non-Disqualification (Annex F)"],
                templates: [], // Add phase 4 templates here
                steps: [
                    { step: "4.1", activity: "Prepare Petition/Manifestation", deliverable: "Verified Petition or Manifestation", legalBasis: "R.A. 7941 (Sec. 5)", doc: "Verified Petition / Manifestation" },
                    { step: "4.2", activity: "Consolidate Annexes", deliverable: "Annexes A-I", legalBasis: "COMELEC Res. 10690", doc: "Complete Annex Set" },
                    { step: "4.3", activity: "File with COMELEC", deliverable: "Filing Receipt", legalBasis: "R.A. 7941", doc: "Official Filing Receipt" },
                    { step: "4.4", activity: "Publish Petition", deliverable: "Newspaper Clippings/Affidavit", legalBasis: "R.A. 7941", doc: "Proof of Publication (Petition)" },
                    { step: "4.5", activity: "Hearing & Accreditation", deliverable: "Cert of Registration", legalBasis: "COMELEC Mandate", doc: "COMELEC Accreditation Certificate" }
                ]
            },
            {
                id: "phase-5",
                phase: "Phase V: Nominee Submission & Pre-Election",
                timeline: "12 Months before Election",
                documents: ["List of 5 Nominees", "Certificate of Nomination (CON)", "Certificate of Acceptance (CAN)", "Affidavit Attesting Qualifications", "Authority to File / Sec Cert", "SOCE Compliance Plan"],
                templates: [], // Add phase 5 templates here
                steps: [
                    { step: "5.0", activity: "Select Nominees", deliverable: "List of 5 Nominees", legalBasis: "R.A. 7941 (Sec. 8)", doc: "Final List of Nominees" },
                    { step: "5.1", activity: "Execute Nomination Docs", deliverable: "CON, CAN, Auth to File", legalBasis: "R.A. 7941", doc: "CON, CAN & Authority to File" },
                    { step: "5.2", activity: "Attest Qualifications", deliverable: "Affidavit of Qualifications", legalBasis: "COMELEC Rules", doc: "Affidavit Attesting to Nominee Qualifications" },
                    { step: "5.3", activity: "File Nominees", deliverable: "Filing Receipt", legalBasis: "R.A. 7941", doc: "Official Nomination Filing Receipt" },
                    { step: "5.4", activity: "Campaign & SOCE", deliverable: "SOCE Filing", legalBasis: "R.A. 7166", doc: "Statement of Contrib. & Expenditures" }
                ]
            }
        ];

        // --- FUNCTIONS ---

        function initUser() {
            let storedId = localStorage.getItem('partyListUserId');
            if (!storedId) {
                storedId = 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('partyListUserId', storedId);
            }
            window.userId = storedId;
            const display = document.getElementById('user-id-display');
            if(display) display.textContent = storedId;
        }

        window.downloadTemplate = function(phaseId) {
            const selector = document.getElementById(`template-select-${phaseId}`);
            if (!selector || selector.selectedIndex === 0) { alert("Please select a template."); return; }
            const phase = planData.find(p => p.id === phaseId);
            const template = phase.templates[selector.selectedIndex - 1];
            const blob = new Blob([template.content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = template.filename;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        };

        function savePhaseCompletion(phaseId, isChecked) {
            let status = JSON.parse(localStorage.getItem('phaseStatus') || '{}');
            status[phaseId] = isChecked; localStorage.setItem('phaseStatus', JSON.stringify(status));
            const el = document.getElementById(phaseId); if(el) isChecked ? el.classList.add('completed-phase') : el.classList.remove('completed-phase');
        }

        function loadPhaseCompletion() {
            const status = JSON.parse(localStorage.getItem('phaseStatus') || '{}');
            planData.forEach(phase => {
                const isChecked = status[phase.id] === true;
                const checkbox = document.getElementById(`check-${phase.id}`);
                if (checkbox) checkbox.checked = isChecked;
                const el = document.getElementById(phase.id); if(el && isChecked) el.classList.add('completed-phase');
            });
        }

        window.handleFileUpload = async function(phaseId, fileInputId) {
            const fileInput = document.getElementById(fileInputId);
            if (!fileInput || !fileInput.files.length) { alert("Please select a file."); return; }
            const file = fileInput.files[0];
            
            // Backend Logic Integration
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phaseId: phaseId, docName: file.name, userId: window.userId })
                });
                
                // NOTE: If API_URL is default, this will 404. We catch and show success for frontend demo.
                // In production, check response.ok here.
            } catch (e) { console.warn("Backend unreachable (expected in demo mode):", e); }

            // Update UI
            const logId = `log-${phaseId}`;
            const logElement = document.getElementById(logId);
            if (logElement) {
                 if (logElement.querySelector('.placeholder-text')) logElement.innerHTML = '';
                 const date = new Date().toLocaleString();
                 logElement.innerHTML += `<p class="text-xs text-stone-600 mt-1 bg-green-50 p-1 rounded border border-green-100"><span class="font-bold text-emerald-600">✓ Uploaded:</span> ${file.name} <span class="text-stone-400">(${date})</span></p>`;
                 logElement.scrollTop = logElement.scrollHeight;
            }
            alert(`File "${file.name}" logged (Simulated Cloud Upload).`);
        };

        function renderTimeline() {
            const timelineContainer = document.getElementById('timeline-container');
            if (!timelineContainer) return;
            let html = '';
            planData.forEach(phase => {
                let templateSectionHTML = '';
                if (phase.templates && phase.templates.length > 0) {
                    templateSectionHTML = `
                        <div class="bg-stone-100 rounded-lg p-4 mt-4 border border-stone-200 shadow-sm">
                            <h4 class="text-sm font-bold text-stone-700 mb-2 flex items-center">Template Library</h4>
                            <div class="flex flex-col sm:flex-row gap-2">
                                <select id="template-select-${phase.id}" class="flex-grow text-sm border-stone-300 rounded-md shadow-sm p-2"><option value="">Select a template...</option>${phase.templates.map(t => `<option value="${t.name}">${t.name}</option>`).join('')}</select>
                                <button onclick="window.downloadTemplate('${phase.id}')" class="bg-emerald-600 text-white text-sm px-4 py-2 rounded-md shadow-sm">Download .MD</button>
                            </div>
                        </div>`;
                }

                html += `
                    <section id="${phase.id}" class="relative pl-8 sm:pl-12 border-l-4 border-emerald-200 transition-all duration-300">
                        <div class="absolute -left-3.5 top-6"><span class="w-6 h-6 bg-emerald-600 rounded-full flex items-center justify-center ring-8 ring-stone-50"><span class="w-3 h-3 bg-white rounded-full"></span></span></div>
                        <div class="phase-banner bg-white p-5 rounded-xl border border-stone-200 shadow-sm mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <div class="flex-grow"><h3 class="phase-title text-2xl font-bold text-emerald-700">${phase.phase}</h3><p class="text-stone-500 font-medium mt-1">${phase.timeline}</p></div>
                            <div class="flex-shrink-0"><label for="check-${phase.id}" class="flex items-center space-x-3 bg-stone-50 px-4 py-2 rounded-lg border border-stone-200 cursor-pointer hover:bg-emerald-50"><input type="checkbox" id="check-${phase.id}" data-phase-id="${phase.id}" class="h-5 w-5 text-emerald-600 rounded"><span class="text-sm font-bold text-stone-700">Mark Phase Complete</span></label></div>
                        </div>
                        <div class="bg-white rounded-lg shadow-inner p-4 mb-8 border border-emerald-100">
                            ${templateSectionHTML}
                            <div class="my-6 border-t border-stone-200"></div>
                            <h4 class="text-lg font-semibold text-stone-800 mb-2">Key Documents to Prepare</h4>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                                ${phase.documents.map((docName, i) => {
                                    const inputId = `upload-main-${phase.id}-${i}`;
                                    return `<div class="flex items-center justify-between bg-stone-50 p-3 rounded-md border border-stone-200"><span class="text-stone-700 font-medium truncate w-1/2" title="${docName}">${docName}</span><div class="flex items-center gap-2"><input type="file" id="${inputId}" class="hidden" onchange="window.handleFileUpload('${phase.id}', '${inputId}')" /><label for="${inputId}" class="cursor-pointer bg-emerald-500 text-white text-xs font-medium px-3 py-1 rounded-full shadow-sm">Upload PDF</label></div></div>`;
                                }).join('')}
                            </div>
                            <div id="log-${phase.id}" class="mt-4 p-2 bg-stone-100 rounded h-24 overflow-y-auto text-xs border border-stone-300"><p class="text-stone-500 placeholder-text">No documents logged yet.</p></div>
                        </div>
                        <div class="space-y-8">
                            ${phase.steps.map((step, index) => {
                                const subInputId = `upload-sub-${phase.id}-${index}`;
                                return `<div class="relative"><div class="absolute -left-9 sm:-left-13.5 top-1"><span class="w-3 h-3 bg-stone-300 rounded-full ring-4 ring-stone-50"></span></div><div class="bg-white rounded-lg shadow-md border border-stone-200 overflow-hidden"><div class="px-5 py-4"><h4 class="text-lg font-bold text-stone-800"><span class="text-emerald-600">Step ${step.step}:</span> ${step.activity}</h4></div><div class="details-content" data-step="${phase.id}-${index}"><div class="px-5 pb-5 border-t border-stone-200 pt-4"><h5 class="font-semibold text-stone-700">Deliverable:</h5><p class="mt-1 text-sm text-stone-600">${step.deliverable}</p><h5 class="mt-4 font-semibold text-stone-700">Associated Document:</h5><div class="flex items-center justify-between mt-1 p-2 bg-stone-100 rounded border border-stone-200"><p class="text-sm text-stone-600 font-mono pr-2">${step.doc}</p><div class="flex items-center gap-2"><input type="file" id="${subInputId}" class="hidden" onchange="window.handleFileUpload('${phase.id}', '${subInputId}')" /><label for="${subInputId}" class="cursor-pointer bg-emerald-500 text-white text-xs font-medium px-3 py-1 rounded-full shadow-sm">Upload PDF</label></div></div></div></div><button class="toggle-details-btn w-full text-left px-5 py-3 bg-stone-50 hover:bg-emerald-50 border-t border-stone-200 text-sm font-medium text-emerald-700 transition-colors" data-target="${phase.id}-${index}">Show Details <span>&darr;</span></button></div></div>`;
                            }).join('')}
                        </div>
                    </section>`;
            });
            timelineContainer.innerHTML = html;
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            const container = document.getElementById('timeline-container');
            // Accordion Toggle
            container.addEventListener('click', e => {
                const btn = e.target.closest('.toggle-details-btn');
                if (btn) {
                    const content = document.querySelector(`.details-content[data-step="${btn.dataset.target}"]`);
                    if (content) { const open = content.classList.toggle('open'); btn.innerHTML = open ? 'Hide Details <span>&uarr;</span>' : 'Show Details <span>&darr;</span>'; }
                }
            });
            // Completion Checkbox
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', e => savePhaseCompletion(e.target.dataset.phaseId, e.target.checked));
            });
            
            // AI UI Listeners
            const fab = document.getElementById('ai-fab');
            const modal = document.getElementById('ai-modal');
            const closeBtn = document.getElementById('close-ai-modal');
            if(fab && modal) {
                fab.addEventListener('click', () => modal.classList.remove('translate-x-full'));
                closeBtn.addEventListener('click', () => modal.classList.add('translate-x-full'));
            }
            
            // (AI Buttons and Chat listeners would go here - simplified for stability)
        }
        
        async function callGeminiAPI(prompt) { /* ... AI Logic ... */ }

        document.addEventListener('DOMContentLoaded', () => {
            initUser();
            renderTimeline();
            setupEventListeners();
            loadPhaseCompletion();
        });
    </script>
</body>
</html>